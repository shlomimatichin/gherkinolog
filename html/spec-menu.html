<link rel="import" href="../bower_components/core-menu/core-submenu.html">
<script src="../bower_components/jquery/dist/jquery.min.js"></script>
<script src="../js/stringutils.js"></script>
<script src="../js/directory.js"></script>
<script src="../bower_components/underscore/underscore-min.js"></script>
<script src="../js/gherkin.js"></script>

<polymer-element name="spec-menu">
  <template>
    <core-menu on-core-select="{{selectAction}}">
      <template repeat="{{directory, i in spec}}">

        <template if="{{directory.subdirectories.length > 0}}">
          <core-submenu icon="expand-more" label="{{directory.title}}" data-dir="{{directory.dirAbsPath}}">
            <template repeat="{{subdirectory, j in directory.subdirectories}}">

              <core-item label="{{subdirectory.title}}" data-dir="{{subdirectory.dirAbsPath}}"></core-item>

            </template>
          </core-submenu>
        </template>
        <template if="{{directory.subdirectories.length == 0}}">
          <core-item label="{{directory.title}}" data-dir="{{directory.dirAbsPath}}"></core-item>
        </template>

      </template>
    </core-menu>
  </template>
  <script>
Polymer('spec-menu', new function() {
    var self = this;

    self.getSpecRootURL = function() {
        var getParameters = parseGetParametersFromURL();
        var root = getParameters.root;
        if (getParameters.root !== undefined)
            return getParameters.root;
        else
            return currentURLDirname() + "spec/";
    };

    self.spec = [];
    self.specParsingInProgress = 0;
    self.specRootURL = self.getSpecRootURL();
    self.specDirectories = {};
    self.featureFiles = {};

    self.newFetch = function() {
        self.specParsingInProgress += 1;
    }

    self.fetchCompletes = function() {
        self.specParsingInProgress -= 1;
        if (self.specParsingInProgress == 0)
            self.doneFetchingEverything();
    }

    self.Directory = function( dirAbsPath, title ) {
        var self = this;

        self.dirAbsPath = dirAbsPath;
        self.title = title;
        self.subdirectories = [];
        self.featureFiles = [];
    }

    self.fileFound = function( dirAbsPath, filename ) {
        if ( filename == "title.txt" ) {
            self.newFetch();
            $.ajax({url: dirAbsPath + filename}).done(function( title ) {
                var properDirPath = deleteTerminatingSlash(dirAbsPath);
                var directory = new self.Directory(properDirPath, stringStripWhitespace(title));
                self.specDirectories[properDirPath] = directory;
                self.fetchCompletes();
            });
        }
        if ( stringEndsWith( filename, ".feature" ) ) {
            self.newFetch();
            $.ajax({url: dirAbsPath + filename}).done(function( contents ) {
                var parsed = parseGherkin( dirAbsPath + filename, contents );
                self.featureFiles[dirAbsPath + filename] = parsed;
                self.fetchCompletes();
            });
        }
    }

    self.doneFetchingEverything = function() {
        var keys = _.keys(self.specDirectories);
        keys.sort();
        for (var i in keys) {
            var dirAbsPath = keys[i];
            var directory = self.specDirectories[dirAbsPath];
            var parentDirectoryPath = stringDirname(dirAbsPath);
            if (parentDirectoryPath == deleteTerminatingSlash(self.specRootURL)) {
                self.spec.push(directory);
            } else {
                self.specDirectories[parentDirectoryPath].subdirectories.push(directory);
            }
        }
        for (var featureFileFilename in self.featureFiles) {
            var featureFile = self.featureFiles[featureFileFilename];
            var parentDirectoryPath = stringDirname(featureFileFilename);
            self.specDirectories[parentDirectoryPath].featureFiles.push(featureFile);
            _.sortBy(self.specDirectories[parentDirectoryPath], function(featureFile) { return featureFile.title; } );
        }
    }

    self.recursiveScanDirectory = function( dirAbsPath ) {
        self.newFetch();
        getDirectoryListing({
            url: dirAbsPath,
            callbackPerDir: function( dirname ) { 
            self.recursiveScanDirectory( dirAbsPath + dirname ); },
            callbackPerFile: function( filename ) { self.fileFound( dirAbsPath, filename ); },
            callbackDone: self.fetchCompletes });
    }

    self.selectAction = function(e, detail) {
        if (! detail.isSelected) {
            this.fire('spec-menu-unselected', {});
        } else {
            var directory = self.specDirectories[detail.item.dataset.dir];
            this.fire('spec-menu-selected', {directory: directory});
        }
    }

    $(function(){
        self.newFetch();
        getDirectoryListing({
            url: self.specRootURL,
            callbackPerDir: function( dirname ) {
            self.recursiveScanDirectory( self.specRootURL + dirname ); },
            callbackPerFile: function( filename ) {
            self.fileFound( self.specRootURL, filename ); },
            callbackDone: self.fetchCompletes });
    });
});
  </script>
</polymer-element>
